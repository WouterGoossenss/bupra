---
title: "Project BUPRA"
author: "Wouter Goossens, Daan Roosen"
date: "22-11-2017"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(bupaR)
library(lubridate)
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(readr)
data <- read_delim("data.csv", 
    ";", escape_double = FALSE, trim_ws = TRUE)
data <- data %>%
  mutate(Timestamp = ymd_hms(substr(`Complete Timestamp`, 1, nchar(`Complete Timestamp`) - 4))) %>%
  mutate(activity_instance_id = row_number()) %>%
  mutate(case_id = `Case ID`) %>% select(-`Case ID`)
log <- data %>%
  eventlog(
    case_id = "case_id",
    activity_id = "Activity",
    activity_instance_id = "activity_instance_id",
    lifecycle_id = "lifecycle:transition",
    timestamp = "Timestamp",
    resource_id = "Resource"
  )
```

##Managementsamenvatting

Om een beter inzicht te krijgen in het facturatieproces van een ziekenhuis, namen wij de dataset 'Hospital Billing' onder de loop. We starten onze analyse met het samenvatten van enkele belangrijke elementen uit deze dataset. De dataset (of log) bevat informatie over 451.359 activiteiten die precies 100.000 gevallen beschrijven. Deze activiteiten worden uitgevoerd door 1151 verschillende medewerkers. Er zijn 1.022 verschillende manieren (traces) waarop een geval kan worden doorlopen. De 10 meest voorkomende traces nemen samen 91.3% van de totale log in.

```{r}
log %>%
  trace_coverage("trace") %>%
  plot
```

De gemiddelde doorlooptijd bij deze gevallen is 30 dagen, terwijl de gemiddelde doorlooptijd over de hele log gemiddeld 127 dagen bedraagt.

De log bevat 18 soorten activiteiten waaronder de belangrijkste zijn:
  - 'NEW': het aanmaken van een factuur
  - 'FIN': het afwerken van een factuur
  - 'RELEASE': het uitgeven van een factuur
  - 'CODE OK': de status die wordt gegeven wanneer een factuur wordt goedgekeurd
  - 'BILLED': de status die wordt gegeven wanneer een factuur is betaald
  - 'CHANGE DIAGN': wanneer de diagnose waarvoor de factuur oorspronkelijk werd opgesteld wordt gewijzigd
  
```{r}
log %>%
  activities() %>%
  select(-relative_frequency)
```



##Inhoudstafel

##Inleiding



Lifecycle:transaction -> nutteloos attribuut (altijd 'complete')

Variant index -> identifier van de trace

##Resultaten

1. Hoeveel facturen worden uiteindelijk niet betaald?

```{r}
log %>%
  group_by(case_id) %>%
  summarise(
    last_activity = last(Activity)
  ) %>%
  filter(last_activity != "BILLED")

```

2. Welke activiteiten moeten vaak opnieuw worden uitgevoerd?

3. Hoe lang duren de verschillende activiteiten?

4. Wat zorgt ervoor dat cases langer duren? (bottlenecks)

5. Welke diagnose duurt het langst om vast te stellen? (gepikt van Quinten & Leen)

6. Welke traces eindigen vaak geblokkeerd?

7. Welke diagnose wordt later het vaakst veranderd?

```{r}
log %>%
  filter(!is.na(diagnosis)) %>%
  group_by(case_id) %>%
  summarise(
    n = n()
  ) %>%
  filter(n > 1) %>%
  left_join(
    log %>%
      select(case_id, diagnosis, activity_instance_id, Activity) %>%
      filter(!is.na(diagnosis))
  ) %>%
  filter(Activity == "CHANGE DIAGN") %>%
  mutate(wrong_diagnosis = ifelse(case_id == lead(case_id), T, F)) %>%
  filter(wrong_diagnosis == T) %>%
  select(diagnosis, wrong_diagnosis) %>%
  group_by(diagnosis, wrong_diagnosis) %>%
  summarise(
    frequency = n()
  ) %>%
  arrange(-frequency) %>%
  select(-wrong_diagnosis)
```

8. Welke eerste diagnose was vaak toch de juiste?

9. Welke diagnoses volgen mekaar vaak op?

```{r}
log %>%
  filter(!is.na(diagnosis)) %>%
  group_by(case_id) %>%
  summarise(
    n = n()
  ) %>%
  filter(n > 1) %>%
  left_join(
    log %>%
      select(case_id, diagnosis, activity_instance_id, Activity) %>%
      filter(!is.na(diagnosis))
  ) %>%
  arrange(-n, case_id, activity_instance_id) %>%
  filter(Activity == "CHANGE DIAGN") %>%
  mutate(previous_diagnosis = ifelse(case_id == lag(case_id), lag(diagnosis), NA)) %>%
  select(previous_diagnosis, diagnosis, case_id) %>%
  filter(!is.na(previous_diagnosis)) %>%
  group_by(previous_diagnosis, diagnosis) %>%
  summarise(
    frequency = n()
  ) %>%
  arrange(-frequency)
```

10. Hoe vaak zijn dokters het niet helemaal eens over de diagnose?

11. Hoevaak wordt een eerst afgewezen diagnose, toch opnieuw gesteld?

##Beperkingen

##Conclusie



















